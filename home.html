<!DOCTYPE html>
<html>
<head>
<title>La perf à Aulnay ...</title>
<!-- Mobile Specific Metas
	  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONT
	  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600"
	rel="stylesheet" type="text/css">

<!-- CSS staticc resources through an abssolute url definedd in app.yaml https://cloud.google.com/appengine/docs/python/gettingstartedpython27/staticfiles 
	  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="stylesheet" href="/css/normalize.css" />
<link rel="stylesheet" href="/css/skeleton.css" />

<!-- 
	  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="icon" type="image/png" href="/images/favicon.png" />
</head>
<body> <!-- For the form http://getskeleton.com/#examples -->
	<div class="container" class="docs-section">
		<form action="{{ upload_url }}" id="gpsForm" method="POST" enctype="multipart/form-data">
			<div class="row">
				<div class="twelve columns">
				      <label for="TitlelInput">Le Titre de votre performance:</label>
				      <input class="u-full-width" placeholder="Le titre de votre performance" id="TitlelInput" type="text">
				    </div>
				   </div>
				   <div class="row">
				    <div class="six columns">
				     <label for="FichierInput">La trace GPS à charger depuis votre ordinateur:</label>
				      <input class="u-full-width" placeholder="votre_fichier_gps.gpx" id="FichierInput" name="gpxfile" type="file">
				    </div>
				    <div class="six columns">
				      <input class="button-primary" value="importer et afficher" type="button" id="gpxsub">
				</div>
			</div>
		</form>
		 <div class="row">
			<div class="ten columns" id="chart">
			</div>
			<div class="two columns" id="downloadsection">
				<form name="image-download" action="" onsubmit="return false"><!-- http://www.humblesoftware.com/flotr2/index#!download-image -->
	 					<p><label><input type="radio" name="format" value="png" checked="checked" /> PNG</label></p>
	 					<p><label><input type="radio" name="format" value="jpeg" /> JPEG</label></p>
	 					<p><label><input type="radio" name="format" value="bmp" /> BMP</label></p>
	  				<input class="button-primary" value="importer et afficher" type="button" id="downloadbutton">
	  			</form>
		</div>
		</div>
	</div>
<!--[if lt IE 9]><script src="/js/excanvas.min.js"></script><![endif]-->
    <script src="/js/flotr2.min.js"></script>
    <script src="/js/jquery-2.1.4.min.js"></script>
    <script>
    $( function()  {
    	var export_obj = {
    			'flot2r_canvas':null,
    			'save_action':function(e){
    				var formats_export = $("input[name='format']:checked");
					if(formats_export.length > 0 && export_obj.flot2r_canvas != null){ //pb is in this case the button wich lanced the event
						export_obj.flot2r_canvas.download.saveImage(formats_export[0].value); //http://www.humblesoftware.com/flotr2/index#!download-image
					}
    			},
    	};
    	$("#downloadsection").hide();
    	$("#gpxsub").click(function (e) {
	        // On empêche le navigateur de soumettre le formulaire
            $("#chart").html("");
    		var nomfic = $("#FichierInput").val();
    		if (nomfic.match(/\.gpx$/i)){
	            var $form = $("#gpsForm"); //see http://chez-syl.fr/2015/02/jquery-uploader-une-image-en-ajax-avec-un-apercu-avant-envoi/
	            var formdata = (window.FormData) ? new FormData($form[0]) : null;
	            var data = (formdata !== null) ? formdata : $form.serialize();
	            $.ajax({
	                url: $form.attr('action'),
	                type: $form.attr('method'),
	                contentType: false, // obligatoire pour de l'upload
	                processData: false, // obligatoire pour de l'upload
	                dataType: 'json', // selon le retour attendu
	                data: data,
	                success: function (response) {
	                	var titre = $("#TitlelInput").val();
	     	            if (titre.length == 0){
	     	            	titre = response['fichier'];
	     	            }
	                	var graphdatas = response['speed_datas'];
	                	var styles = {
	 		    	    		//width : "60em",
	 		    	    		height : "40em",
	 		    	    		//backgroundColor : "yellow",
	 		    	    		visibility : "hidden"
	 		    	    }; 
	                	$("#chart").css(styles);
		 		    	$("#chart").addClass("u-full-width");
		 		    	export_obj['flot2r_canvas'] = Flotr.draw(
     		   	           $("#chart")[0] //http://jsfiddle.net/cz37V/1/
     		   	           ,[
     		   	               //{ data: zero, label: "Dates de passage", lines: {show:true, lineWidth: 1}, shadowSize: 0, color: "#545454" },
     		   	               { data: graphdatas, lines: {show:true}},
     		   	            ],
     		   	           {
     		   	        		HtmlText: false, //otherwise the labels are not written on the Canvas and cannot be exported as image !!!
     		   	        	   title: titre,
     		   	               grid: {horizontalLines: true, verticalLines: true},
     			   	            xaxis: { //http://stackoverflow.com/questions/11248927/putting-timestamp-onto-x-axis-in-flotr2-line-graph
     				   	            mode: "time",
     				   	            timeformat: "%H:%M:%S" 
     				   	        },
     		   	            }
     		   	       );
	     		   	   $("#chart").css('visibility','visible');
	     		   	   $("#downloadsection").show();
	     		   		var form_tel = $('form[name="image-download"]');
		     		   	if (navigator.userAgent.match(/msie/i)) { //TODO à vérifier qu'avec canvas.js on ne peut pas télécharger sous IE
							var messageErreur = $('<h5>').html("Votre navigateur ne vous permet pas de télécharger le graphe sous forme d'image");
			    			messageErreur.css('color','red');
			    			form_tel.find(':input:not(:disabled)').prop('disabled',true);
			    			$('#downloadbutton').prop('disabled',true);
			    			$('#downloadsection').prepend(messageErreur);
						}else{
							$('#downloadbutton').click(export_obj.save_action);
						}
	     		   	 }, //fin du success callback
	            }); //Fin de la requête Ajax
    		} else {
    			$("#downloadsection").hide();
    			var messageErreur = $('<h3>').html("<h3>Le fichier :/"+nomfic+"/ n'est pas un fichier GPX valide</h3>");
    			messageErreur.css('color','red');
    			$("#chart").append( messageErreur );
    			$("#chart").css('visibility','visible');
    		}
        }); //fin de la click function de JQuery
   	});
	</script>
</body>
</html>